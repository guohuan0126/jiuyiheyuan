package com.duanrong.drpay.jsonservice.controller;

import javax.annotation.Resource;

import org.apache.commons.lang3.StringUtils;
import org.quartz.SchedulerException;
import org.springframework.stereotype.Controller;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestMethod;
import org.springframework.web.bind.annotation.ResponseBody;

import base.error.ErrorCode;
import base.exception.AccountException;
import base.exception.LoanException;
import base.exception.TradeException;
import base.exception.UserAccountException;

import com.duanrong.drpay.jsonservice.handler.RequestParameter;
import com.duanrong.drpay.jsonservice.handler.View;
import com.duanrong.drpay.jsonservice.param.InvestParameter;
import com.duanrong.drpay.trusteeship.helper.model.Generator;
import com.duanrong.drpay.trusteeship.service.TrusteeshipInvestService;
import com.duanrong.drpay.trusteeship.service.TrusteeshipRepayService;
import com.duanrong.drpay.trusteeship.service.TrusteeshipTradeService;

/**
 * 交易服务
 * 
 * @author xiao
 * @datetime 2016年12月9日 下午2:09:12
 */
@Controller
@RequestMapping(value = "/trade", method = RequestMethod.POST)
public class TradeController extends BaseController {

	@Resource
	TrusteeshipTradeService trusteeshipTradeService;

	@Resource
	TrusteeshipInvestService trusteeshipInvestService;

	@Resource
	TrusteeshipRepayService trusteeshipRepayService;
	
	@RequestMapping(value = "/query")
	@ResponseBody
	public View query(@RequestParameter String requestNo,
			@RequestParameter String type,@RequestParameter int handle) throws UserAccountException,
			TradeException, SchedulerException {
		View view = getView();
		if (StringUtils.isEmpty(requestNo)|| StringUtils.isEmpty(type)) {
			view.setError(ErrorCode.ParametersError);
		} else {
			Generator data = trusteeshipTradeService.queryTransaction(requestNo, type,handle);
			view.setData(data);
			view.setError(ErrorCode.SUCCESS);
		}
		return view;
	}

	@RequestMapping(value = "/invest")
	@ResponseBody
	public View createInvest(@RequestParameter InvestParameter params,
			String source) throws AccountException, TradeException,
			SchedulerException {
		View view = getView(source);
		if (params == null || StringUtils.isEmpty(params.getUserId())
				|| StringUtils.isEmpty(params.getLoanId())
				|| params.getMoney() <= 0) {
			view.setError(ErrorCode.ParametersError);
		} else {
			Generator data = trusteeshipInvestService.createInvest(
					params.getUserId(), params.getLoanId(), params.getMoney(),
					params.getRedpacketId(), params.getIsAutoInvest(), view.getType());
			if (data != null) {
				data.setUserDevice(sourceToUserDevice(source));
			}
			view.setData(data);
			view.setError(ErrorCode.SUCCESS);
		}
		return view;
	}

	@RequestMapping(value = "/investAgain")
	@ResponseBody
	public View investAgain(@RequestParameter String userId,
			@RequestParameter String id, String source)
			throws AccountException, TradeException, SchedulerException {
		View view = getView(source);
		if (StringUtils.isEmpty(userId) || StringUtils.isEmpty(id)) {
			view.setError(ErrorCode.ParametersError);
		} else {
			Generator data = trusteeshipInvestService.investAgain(id, view.getType());
			if (data != null) {
				data.setUserDevice(sourceToUserDevice(source));
			}
			view.setData(data);
			view.setError(ErrorCode.SUCCESS);
		}
		return view;
	}

	@RequestMapping(value = "/giveMoneyToBorrower")
	@ResponseBody
	public View giveMoneyToBorrower(@RequestParameter String loanId)
			throws Exception {
		View view = getView();
		if (StringUtils.isEmpty(loanId)) {
			view.setError(ErrorCode.ParametersError);
		} else {
			trusteeshipTradeService.giveMoneyToBorrower(loanId);
			view.setError(ErrorCode.SUCCESS);
		}
		return view;
	}

	@RequestMapping(value = "/repay")
	@ResponseBody
	public View repay(@RequestParameter String id,
			@RequestParameter int beforeRepay, String source)
			throws UserAccountException, TradeException {
		View view = getView(source);
		if (StringUtils.isEmpty(id)) {
			view.setError(ErrorCode.ParametersError);
		} else {
			Generator data = trusteeshipRepayService.createRepay(id,
					beforeRepay, view.getType());
			if (data != null) {
				data.setUserDevice(sourceToUserDevice(source));
			}
			view.setData(data);
			view.setError(ErrorCode.SUCCESS);
		}
		return view;
	}

	/**
	 * 项目流标或者单笔投资流标
	 * 
	 * @throws Exception
	 * @throws AccountException
	 * @throws LoanException
	 */
	@RequestMapping("/bidders.do")
	@ResponseBody
	public View bidders(@RequestParameter String loanId,
			@RequestParameter String investId, @RequestParameter String type)
			throws LoanException, TradeException, AccountException, Exception {
		View view = this.getView();

		if (StringUtils.isBlank(type)) {
			view.setError(ErrorCode.ParametersError);
		} else {
			if (type.equals("loan") && StringUtils.isNoneBlank(loanId)
					|| type.equals("invest")
					&& StringUtils.isNoneBlank(investId)) {
				trusteeshipTradeService.bidders(loanId, investId, type);
				view.setError(ErrorCode.SUCCESS);
			} else {
				view.setError(ErrorCode.ParametersError);
			}
		}
		return view;
	}

	
}
