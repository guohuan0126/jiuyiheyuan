<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.duanrong.drpay.business.payment.mapper.RechargeMapper">
	<resultMap type="Recharge" id="RechargeRM">
		<id property="id" column="recharge_id" />
		<result property="userId" column="user_id" />
		<result property="time" column="time" />
		<result property="actualMoney" column="actual_money" />
		<result property="successTime" column="success_time" />
		<result property="status" column="status" />
		<result property="isRechargedByAdmin" column="is_recharged_by_admin" />
		<result property="fee" column="fee" />
		<result property="rechargeWay" column="recharge_way" />
		<result property="type" column="type" />
		<result property="paymentId" column="payment_id" />
		<result property="cardNo" column="card_no" />
	</resultMap>

	<sql id="allColumns">
		user_id, time, ROUND(actual_money,2) AS actual_money,
		success_time, status, is_recharged_by_admin, fee, id AS recharge_id, recharge_way,payment_id,card_no
	</sql>

	<insert id="insert" parameterType="Recharge">
		INSERT INTO recharge
		(id, time,
		user_id, actual_money, status, is_recharged_by_admin, fee, recharge_way,type,payment_id,card_no)
		VALUES
		(#{id}, NOW(), #{userId},
		#{actualMoney}, #{status}, '0', #{fee}, #{rechargeWay},#{type},#{paymentId},#{cardNo})
	</insert>

	<select id="get" parameterType="string" resultMap="RechargeRM">
		SELECT
		<include refid="allColumns" />
		FROM recharge
		WHERE id = #{id}
	</select>

	<select id="getWithLock" parameterType="string" resultMap="RechargeRM">
		SELECT
		<include refid="allColumns" />
		FROM recharge
		WHERE id = #{id} for update
	</select>
	
	<update id="update" parameterType="Recharge">
		UPDATE recharge
		<set>
			<if test="successTime != null">
				success_time = #{successTime},
			</if>
			<if test="@org.apache.commons.lang3.StringUtils@isNotBlank(status)">
				status = #{status},
			</if>
			<if test="@org.apache.commons.lang3.StringUtils@isNotBlank(type)">
				type = #{type},
			</if>
			<if test="fee!=0">
				fee = #{fee},
			</if>
		</set>
		WHERE id = #{id}
	</update>

	<!-- 根据条件进行组合查询 -->
	<select id="getByCondition" parameterType="Recharge" resultMap="RechargeRM">
		SELECT
		<include refid="allColumns" />
		FROM recharge
		<where>
			<if test="id != null and id != ''">
				AND id = #{id}
			</if>
			<if test="userId != null and userId != ''">
				AND user_id = #{userId}
			</if>
			<if test="time != null and time != ''">
				AND time = #{time}
			</if>
			<if test="actualMoney != null and actualMoney != ''">
				AND actual_money = #{actualMoney}
			</if>
			<if test="successTime != null and successTime != ''">
				AND success_time = #{successTime}
			</if>
			<if test="status != null and status != ''">
				AND status = #{status}
			</if>
			<if test="isRechargedByAdmin != null and isRechargedByAdmin != ''">
				AND is_recharged_by_admin = #{isRechargedByAdmin}
			</if>
			<!-- 其他条件根据需求添加 -->
		</where>
	</select>
	
    <!-- 查询当天快捷充值总额度 -->
	<select id="findQuickRechargeForToday" parameterType="java.lang.String" resultMap="RechargeRM" >
        select <include refid="allColumns" /> from recharge where to_days(time) = to_days(now()) 
        and type = 'quick' and user_id = #{userId} and status = 'success'
	</select>
	
	    <!-- 查询当月快捷充值总额度 -->
	<select id="findQuickRechargeForMonth" parameterType="java.lang.String" resultMap="RechargeRM" >
		SELECT <include refid="allColumns" /> FROM recharge WHERE DATE_FORMAT(time,'%Y%m') = DATE_FORMAT(CURDATE(),'%Y%m')
		 and type = 'quick' and user_id = #{userId} and status = 'success'
	</select>
	
</mapper>