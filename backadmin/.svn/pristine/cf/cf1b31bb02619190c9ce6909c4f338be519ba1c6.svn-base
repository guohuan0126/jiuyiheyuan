<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.duanrong.business.ruralfinance.mapper.AgricultureLoanerInfoMapper">
	 <!-- 基本信息 -->
	<resultMap type="com.duanrong.business.ruralfinance.model.AgricultureLoaninfo" id="loanerinfoRM">
		<id property="id" column="id"  />
		<result property="contractId" column="contract_id" />
		<result property="name" column="name" />
		<result property="sex" column="sex" />
		<result property="age" column="age" />
		<result property="idCard" column="id_card" />
		<result property="mobileNumber" column="mobile_number" />
		<result property="money" column="money" />
		<result property="loanMoney" column="loan_money" />
		<result property="serviceMoney" column="service_money" />
		<result property="loanTerm" column="loan_term" />
		<result property="rate" column="rate" />
		<result property="repayType" column="repay_type" />
		<result property="bankcard" column="bankcard" />
		<result property="bank" column="bank" />
		<result property="branchname" column="branchname" />
		<result property="maritalStatus" column="marital_status" />
		<result property="province" column="province" />
		<result property="city" column="city" />
		<result property="area" column="area" />
		<result property="address" column="address" />
		<result property="annualIncome" column="annual_income" />
		<result property="createTime" javaType="date" column="create_time" />
	    <result property="operateTime" javaType="date" column="operate_time" />
	    <result property="giveMoneyTime" javaType="date" column="givemoneytime" />
	    <result property="userId" column="userid" />
	    <result property="status" column="status" />
	    <result property="forkStatus" column="fork_status" />
	    <result property="remark" column="remark" />
	    <result property="remark1" column="remark1" />
	    <result property="remark2" column="remark2" />
	    <result property="typeOfId" column="id_type" />
	    <result property="customerType" column="customer_type" />
	    <result property="bigArea" column="region" />
	    <result property="businessOffic" column="sales_department" />
	    <result property="customManger" column="account_manager" />
	    <result property="countryApprover" column="county_approver" />
	    <result property="allApprover" column="headquarters_approver" />
	    <result property="flag" column="flag" />
	    <result property="loanApplication" column="loan_application" />
	    <result property="repaymentSource" column="repayment_source" />
	    <result property="compositeInteresRate" column="composite_interestRate" />
	    <result property="accountingDepartment" column="accounting_department" />
	    <result property="whetherEarlyRepayment" column="whether_early_repayment" />
	    <result property="actualLoanTerm" column="actual_loan_term" />
	    <result property="actualEndTime" column="actual_end_time" />
	    <result property="packingStatus" column="packing_status" />
	    <result property="agriculturalType" column="agricultural_type" />
	</resultMap>
	<!-- 子标列表     -->
	<resultMap type="com.duanrong.business.ruralfinance.model.AgricultureForkLoans" id="ForkLoansRM">
			<id property="id" column="id"  />
			<result property="parentId" column="parent_id" />
			<result property="childContractid" column="child_contractid" />
			<result property="loanId" column="loan_id" />
			<result property="money" column="money" />
			<result property="loanTerm" column="loan_term" />
			<result property="packing" column="packing" />
			<result property="createTime" column="create_time" />			
		    <result property="remark" column="remark" />
			<result property="name" column="name" />
			<result property="mobileNumber" column="mobile_number" />
			<result property="idCard" column="id_card" />
			<result property="contractMoney" column="contractMoney" />
			<result property="loanMoney" column="loanMoney" />
			<result property="parentLoanTerm" column="parentLoanTerm" />
			<result property="bankCard" column="bankcard" />
			<result property="contractId" column="contract_id" />
			 <result property="flag" column="flag" />
	</resultMap>
	<!-- 还款计划 -->
	<resultMap type="com.duanrong.business.ruralfinance.model.AgricultureRepaymentPlan" id="RepaymentPlanRM">
		<id property="id" column="id"  />
		<result property="name" column="name" />		
		<result property="contractId" column="contract_id" />
		<result property="money" column="money" />
		<result property="uid" column="userId" />
		<result property="loanDataId" column="loandata_id" />
		<result property="repayDate" column="repay_date" />
		<result property="operationTime" column="operation_time" />
		<result property="monthMoney" column="month_money" />
		<result property="realrepayMoney" column="realrepay_money" />
		<result property="corpus" column="corpus" />
		<result property="intereat" column="intereat" />
		<result property="latePenalty" column="late_penalty" />
		<result property="period" column="period" />
		<result property="repayStatus" column="repay_status" />
		<result property="remark" column="remark" />
		<result property="detailsNumber" column="details_number" />
		<result property="compositeInteresRate" column="composite_interestRate" />
		<result property="loanTerm" column="loan_term" />
		<result property="rate" column="rate" />
		<result property="whetherEarlyRepayment" column="whether_early_repayment" />
		<result property="repayType" column="repay_type" />
		<result property="agriculturalType" column="agricultural_type" />
		
	</resultMap>
	<!-- 导出模板 -->
	<resultMap type="com.duanrong.business.ruralfinance.model.Template" id="Template">
	   	<result property="id" column="id" />
		<result property="bankName" column="bank" />
		<result property="accountType" column="customer_type"/>
		<result property="userName" column="name" />
		<result property="bankNum" column="bankcard" />
		<result property="branchname" column="branchname" />
		<result property="province" column="province" />
		<result property="city" column="city" />
		<result property="idType" column="id_type" />
		<result property="idCard" column="id_card" />
		<result property="monthMoney" column="month_money" />
		<result property="latePenalty" column="late_penalty" />
		<result property="accountType" column="customer_type" />
		<result property="repayStatus" column="repay_status" />
		<result property="detailsNumber" column="details_number" />
		<result property="mobileNum" column="mobile_number" />
		<result property="protocolUserID" column="contract_id" />
	</resultMap>
	<!-- 导出模板 -->
	<resultMap type="com.duanrong.business.ruralfinance.model.LoanerinfoExport" id="LoanerinfoExport">
		<result property="id" column="id" />
		<result property="contractId" column="contract_id"/>
		<result property="name" column="name" />
		<result property="idCard" column="id_card" />
		<result property="idType" column="id_type" />
		<result property="mobileNumber" column="mobile_number" />
		<result property="bankcard" column="bankcard" />
		<result property="bank" column="bank" />
		<result property="branchname" column="branchname" />
		<result property="customerType" column="customer_type" />
	</resultMap>
  	<!-- 查询所有 -->
	<select id="readAgricultureLoaninfoPageInfo" resultMap="loanerinfoRM">
		select * from agriculture_loaninfo where status!='delete'
		<if test="id !=null and id != ''">
			AND contract_Id=#{id}
		</if>
		<if test="status != null and status != ''">
			and status=#{status} 
		</if>
		<if test="forkStatus != null and forkStatus != ''">
			and fork_status=#{forkStatus} 
		</if>
		<if test="start != null and start != ''">
			and create_time &gt;=#{start} 
		</if>
		<if test="end != null and end != ''">
			and create_time &lt;=#{end} 
		</if>
		<if test="loanTerm != null and loanTerm != ''">
			and loan_term=#{loanTerm} 
		</if>
		<if test="flag != null and flag != ''">
			and flag=#{flag} 
		</if>
		<if test="fkstart != null and fkstart != ''">
			and giveMoneyTime &gt;=#{fkstart} 
		</if>
		<if test="fkend != null and fkend != ''">
			and giveMoneyTime &lt;=#{fkend} 
		</if>	
		<if test="remark1 != null and remark1 != ''">
			and remark1=#{remark1} 
		</if>
		<if test="accountingDepartment != null and accountingDepartment != ''">
			and accounting_department=#{accountingDepartment} 
		</if>
		<if test="repayType != null and repayType  != ''">
			and repay_type=#{repayType} 
		</if>
		<if test="packingStatus != null and packingStatus != ''">
			and packing_status=#{packingStatus} 
		</if>
		<if test="whetherEarlyRepayment != null and whetherEarlyRepayment != ''">
			and whether_early_repayment=#{whetherEarlyRepayment} 
		</if>
		<if test="agriculturalType != null and agriculturalType != ''">
			and agricultural_type=#{agriculturalType} 
		</if>					
		order by create_time DESC
	</select>
	
	<!--查询子标信息 -->
	<select id="readAgricultureForkLoansPageInfo" parameterType="map"  resultMap="ForkLoansRM">
		SELECT r2.*,r1.name,r1.mobile_number,r1.id_card,r1.bankcard,r1.contract_id,r1.money as contractMoney,r1.loan_money AS loanMoney ,r1.loan_term AS parentLoanTerm
		from agriculture_fork_loans r2 LEFT JOIN agriculture_loaninfo r1 on r2.parent_id=r1.id
		<where>
		<if test="forkStatus != null and forkStatus != ''">
			and r2.packing=#{forkStatus} 
		</if>
		<if test="start != null and start != ''">
			and r2.create_time &gt;=#{start} 
		</if>
		<if test="end != null and end != ''">
			and r2.create_time &lt;=#{end} 
		</if>
		<if test="loanTerm != null and loanTerm != ''">
			and r2.loan_term=#{loanTerm} 
		</if>
		<if test="contractId != null and contractId != ''">
			and r1.contract_id=#{contractId} 
		</if>
		<if test="loanId != null and loanId != ''">
			and r2.loan_id=#{loanId} 
		</if>
		</where>
		order by r2.create_time desc,r2.loan_term
	</select>
	
	<!-- 根据id查询借款基本信息 -->
	<select id="readAgricultureLoaninfoById" parameterType="String" resultMap="loanerinfoRM">
		select * from agriculture_loaninfo where fork_status=0 and id=#{id}
	</select>
	<!-- 根据id 修改状态 -->
	<update id="updateStatusById" parameterType="map">
		UPDATE agriculture_loaninfo SET status = #{status} where id=#{id}
	</update>
	<update id="updateForkStatusById" parameterType="map">
		UPDATE agriculture_loaninfo 
		<set>
		<if test="packingStatus != null and packingStatus != ''"> packing_status= #{packingStatus},</if>
		fork_status=#{forkStatus} 
		</set>		
		where id=#{id}
	</update>
	
	<select id="readAgricultureForkLoansById" parameterType="String" resultMap="ForkLoansRM">
		select *from agriculture_fork_loans where parent_id=#{id}
		order by loan_term 
	</select>
	<!-- 查询还款计划 -->
	<select id="readRuralfinanceRepaymentPlan" parameterType="map" resultMap="RepaymentPlanRM">
		SELECT a2.name,a2.contract_id,a2.id AS userId,a2.money,a2.composite_interestRate,a2.rate,a2.loan_term,a2.repay_type,a2.whether_early_repayment,a1.* from agriculture_repaymentplan a1,agriculture_loaninfo a2 WHERE a2.id=a1.loandata_id
		<if test="id != null and id != ''">
			AND a2.contract_id=#{id}
		</if>
		<if test="name != null and name != ''">
			and a2.name=#{name}
		</if>
		<if test="start != null and start != ''">
			AND a1.repay_date &gt;=#{start}
		</if>
		<if test="end != null and end != ''">
			and a1.repay_date &lt;=#{end}
		</if>
		<if test="fkstart != null and fkstart != ''">
			and a2.giveMoneyTime &gt;=#{fkstart} 
		</if>
		<if test="fkend != null and fkend != ''">
			and a2.giveMoneyTime &lt;=#{fkend} 
		</if>	
		<if test="accountingDepartment != null and accountingDepartment != ''">
			and a2.accounting_department=#{accountingDepartment} 
		</if>
		<if test="repayType != null and repayType != ''">
			and a2.repay_type=#{repayType} 
		</if>
		<if test="whetherEarlyRepayment != null and whetherEarlyRepayment != ''">
			and a2.whether_early_repayment=#{whetherEarlyRepayment} 
		</if>	
		<if test="repayStatus != null and repayStatus != ''">
			and a1.repay_status=#{repayStatus} 
		</if>		
		order by a1.repay_date
	</select>
	<!-- 查询所有还款计划 -->
	<select id="findAllPlan"  resultMap="RepaymentPlanRM">
		SELECT a2.name,a2.contract_id,a2.id AS userId,a2.money,a2.composite_interestRate,a2.rate,a2.loan_term,a2.repay_type,a2.whether_early_repayment,a2.agricultural_type,a1.* from agriculture_repaymentplan a1,agriculture_loaninfo a2 WHERE a2.id=a1.loandata_id
		AND repay_status!='finish'
	</select>
	<!-- 更新罚息 -->
	<update id="renewalLatePenalty" parameterType="map">
		UPDATE agriculture_repaymentplan SET late_penalty =#{latePenalty} where id=#{id}
	</update>
	
	
	<!-- 更新基本信息flag -->
	<update id="updateFlag" parameterType="map">
		UPDATE agriculture_loaninfo SET flag=#{flag} where id=#{id}
	</update>
	<!-- 修改还款状态 -->
	<update id="updateRepaymentplanStatus" parameterType="map">
		UPDATE agriculture_repaymentplan SET repay_status =#{status} where id=#{id}
	</update>

	<!-- 根据id 查询 为生成还款计划的model（基本信息） -->
	<select id="readAgricultureLoaninfoByIdAndFlag" parameterType="String" resultMap="loanerinfoRM">
	select * from agriculture_loaninfo where flag=0 and id=#{id}
		</select>
	<!-- 根据借款id 查询所有剩余应还金额-->
	<select id="readneedRepayMoney" parameterType="String" resultType="double">
		SELECT IFNULL(sum(month_money),0) FROM agriculture_repaymentplan WHERE id=#{loanDataId}    AND repay_status!='finish'
	</select>
	<!-- 查询还款计划(未完成) -->
	<select id="readRuralfinanceFailRepaymentPlan" parameterType="map" resultMap="RepaymentPlanRM">
		SELECT a2.name,a2.id AS userId,a2.money,a1.* from agriculture_repaymentplan a1,agriculture_loaninfo a2 WHERE a2.id=a1.loandata_id 
		and a1.repay_status !='finish'
	</select>
	
	<!-- 导出还款计划 -->
	<select id="readTemplate" parameterType="map" resultMap="Template">
		SELECT a1.*,a2.* from agriculture_repaymentplan a1,agriculture_loaninfo a2 WHERE a2.id=a1.loandata_id
		<if test="data != null and data != ''">
			and date_format(a1.repay_date,'%Y-%m-%d') &lt;=#{data}
		</if>
		and a1.repay_status!='finish'
		and a2.accounting_department=1
		order by repay_date DESC
	</select>
	
		
	<!-- 导出还款计划 -->
	<select id="readLoanerinfoExport" resultMap="LoanerinfoExport">
	select * from agriculture_loaninfo where status!='delete'		
	</select>
	<select id="readAgriculturePacking" resultMap="loanerinfoRM" parameterType="map" >
	select * from agriculture_loaninfo where status!='delete' and repay_type='先息后本' 
	<if test="packingStatus != null and packingStatus != ''">
		and packing_status=#{packingStatus}
	</if>	
	order by create_time DESC
	</select>
	<select id="readAgricultureByLoanerinfoId" parameterType="String" resultMap="loanerinfoRM">
		select * from agriculture_loaninfo where id=#{id}
	</select>
	<!-- 批量修改天天赚打包状态 -->
<update id="updatePackStatus" parameterType="Map">    
        update agriculture_loaninfo set       
            packing_status= #{packingStatus}  
        where id in     
        <foreach collection="arr" index="index" item="item" open="(" separator="," close=")" >    
            #{item}    
        </foreach>  
</update> 
<!-- 更新提前还款借款项目的信息 -->
	<update id="updateTimelyLoaninfo" parameterType="map">
		UPDATE agriculture_loaninfo
		<set>
			<if test="whetherEarlyRepayment != null and whetherEarlyRepayment != ''">whether_early_repayment=#{whetherEarlyRepayment},</if>
			<if test="actualLoanTerm != null and actualLoanTerm != ''">actual_loan_term=#{actualLoanTerm},</if>
			<if test="actualEndTime != null">actual_end_time=#{actualEndTime},</if>
			<if test="status != null and status != ''">status = #{status}</if>
		</set>
		WHERE contract_id=#{contractId}
	</update>
	<select id="readTimelyloansRepaymentPlan" parameterType="String" resultMap="RepaymentPlanRM">
		SELECT a2.name,a2.contract_id,a2.id AS userId,a2.money,a2.composite_interestRate,a2.rate,a2.loan_term,a2.repay_type,a2.whether_early_repayment,a1.* from agriculture_repaymentplan a1,agriculture_loaninfo a2 WHERE a2.id=a1.loandata_id	
			AND a2.contract_id=#{id}
	</select>
	<select id="readAgricultureBycontractId" parameterType="map" resultMap="loanerinfoRM">
		select * from agriculture_loaninfo
	   <if test="byType != null and byType == 1 ">
		where contract_id=#{ssid}
		</if>
		<if test="byType != null and byType ==2 ">
		where id_card=#{ssid}
		</if>						
	</select>
	<select id="findBySubContractId" parameterType="java.lang.String" resultMap="RepaymentPlanRM">
	SELECT a2.name,a2.contract_id,a2.id AS userId,a2.money,a2.composite_interestRate,a2.rate,a2.loan_term,a2.repay_type,a2.whether_early_repayment,a1.* from agriculture_repaymentplan a1,agriculture_loaninfo a2 WHERE a2.id=a1.loandata_id	
			AND a2.contract_id like '${_parameter}%'	
	</select>
	<update id="updateLoaninfobank" parameterType="map">
		UPDATE agriculture_loaninfo
		<set>
			<if test="bankcard != null and bankcard != ''">bankcard=#{bankcard},</if>
			<if test="bank != null and bank != ''">bank=#{bank},</if>
			<if test="branchname != null and branchname != ''">branchname = #{branchname}</if>
		</set>
		WHERE id=#{id}
	</update>
	<select id="readRepaymentPlanById" parameterType="String" resultMap="RepaymentPlanRM">
		SELECT a2.name,a2.contract_id,a2.id AS userId,a2.money,a2.composite_interestRate,a2.rate,a2.loan_term,a2.repay_type,a2.whether_early_repayment,a1.* from agriculture_repaymentplan a1,agriculture_loaninfo a2 WHERE a2.id=a1.loandata_id	
			AND a1.id=#{id}
	</select>
	
</mapper>