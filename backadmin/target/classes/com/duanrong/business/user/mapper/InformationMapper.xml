<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.duanrong.business.user.mapper.InformationMapper">
	<resultMap type="information" id="informationRM">
		<id property="id" column="id" />
		<result property="username" column="username" />
		<result property="time" column="time" />
		<result property="status" column="status" />
		<result property="title" column="title" />
		<result property="content" column="content" />
		<result property="isRead" column="is_read" />
		<association property="user" column="username"
			resultMap="com.duanrong.business.user.mapper.UserMapper.userRM"/>
	</resultMap>

	<insert id="insert">
		INSERT INTO information
		(id, username, time, status,
		title, content, is_read)
		VALUES
		(#{id}, #{username}, #{time}, #{status},
		#{title}, #{content}, #{isRead})
	</insert>

	<select id="findAll" resultMap="informationRM">
		SELECT * FROM information
	</select>

	<!-- 根据用户ID获得用户所有站内信 -->
	<select id="getInformationByUserId" parameterType="string"
		resultMap="informationRM">
		SELECT * FROM information
		WHERE username = #{userId} AND status = 1
		ORDER BY time DESC
	</select>

	<!-- 根据用户ID获取未读站内信 -->
	<select id="getNotReadByUserId" parameterType="string"
		resultType="long">
		SELECT COUNT(id) FROM information
		WHERE is_read = 0 AND username = #{userId} AND status = 1
	</select>

	<!-- 设置站内信已读 -->
	<update id="updateRead" parameterType="string">
		UPDATE information
		SET is_read=1
		WHERE username = #{userId}
	</update>

	<!-- 分页查询 -->
	<select id="findPaging" parameterType="pageData" resultMap="informationRM">
		SELECT * FROM information
		WHERE username = #{params.entity.username}
		AND status = 1
		ORDER BY time DESC
	</select>
  <select id="pageInfo" parameterType="map" resultMap="informationRM">
		SELECT r.*,u.realname as realname
		FROM information r left JOIN user u ON r.username = u.id
		<where>
		    <if test="userId != null and userId != ''">
				AND r.username like '%${userId}%'
			</if>
			<if test="type != null and type != ''">
				AND r.is_read= #{type}
			</if>
			<if test="mnumber != null and mnumber != ''">
				AND u.mobile_number = #{mnumber}
			</if>
			<if test=" realname != null and realname != ''">
				AND u.realname like '%${realname}%'
			</if>
			<if test="@org.apache.commons.lang3.StringUtils@isNotBlank(start)">
				AND r.time &gt;= #{start}
			</if>
			<if test="@org.apache.commons.lang3.StringUtils@isNotBlank(end)">
				AND r.time &lt;= #{end}
			</if>
		</where>
		ORDER BY r.time DESC
	</select>
</mapper>