<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.duanrong.business.sms.mapper.SmsMapper">
	<resultMap type="Sms" id="SmsRM">
		<id property="id" column="id" />
		<result property="userId" column="user_id" />
		<result property="mobileNumber" column="mobile_number" />
		<result property="content" column="content" />
		<result property="time" column="time" />
		<result property="type" column="type" />
		<association property="user" column="user_id"
			resultMap="com.duanrong.business.user.mapper.UserMapper.userRM"/>
	</resultMap>
	<resultMap type="Sms" id="SmsRM1">
		<result property="time" column="time" />
		<result property="num" column="num" />
	</resultMap>

	<!-- 根据id查询repay -->
	<select id="get" parameterType="string" resultMap="SmsRM">
		SELECT * FROM
		sms_history
		WHERE id = #{id}
	</select>

	<insert id="insert" parameterType="Sms">
		INSERT INTO sms_history
		(id,
		user_id,
		mobile_number, content, time, type)
		VALUES
		(#{id}, #{userId},
		#{mobileNumber}, #{content}, #{time}, #{type})
	</insert>
    <select id="pageInfo" parameterType="map" resultMap="SmsRM">
		SELECT r.*,u.realname as realname
		FROM sms_history r JOIN user u ON r.user_id = u.id
		<where>
		    <if test="userId != null and userId != ''">
				AND r.user_id like '%${userId}%'
			</if>
			<if test="type != null and type != ''">
				AND r.type= #{type}
			</if>
			<if test="mnumber != null and mnumber != ''">
				AND r.mobile_number = #{mnumber}
			</if>
			<if test=" realname != null and realname != ''">
				AND u.realname like '%${realname}%'
			</if>
			<if test="@org.apache.commons.lang3.StringUtils@isNotBlank(start)">
				AND r.time &gt;= #{start}
			</if>
			<if test="@org.apache.commons.lang3.StringUtils@isNotBlank(end)">
				AND r.time &lt;= #{end}
			</if>
		</where>
		ORDER BY r.time DESC
	</select>
	<select id="getSmsNum" parameterType="map" resultMap="SmsRM1">
		SELECT time,count(*) as num
		FROM sms_history 
		<where>
	    <if test="type != null and type != '' and type=='today'">
			AND DATE(time)=CURDATE()
		</if>
		<if test="type != null and type != '' and type=='yesterday'">
			AND DATE_SUB(CURDATE(), INTERVAL 1 DAY) &lt;= date(time)
		</if>
		<if test="type != null and type != '' and type=='week'">
			AND DATE_SUB(CURDATE(), INTERVAL 1 WEEK) &lt;= date(time)
		</if>
		<if test="@org.apache.commons.lang3.StringUtils@isNotBlank(start)">
			AND time &gt;= #{start}
		</if>
		<if test="@org.apache.commons.lang3.StringUtils@isNotBlank(end)">
			AND time &lt;= #{end}
		</if>
	 </where>
	 GROUP BY date(time)
	</select>
</mapper>